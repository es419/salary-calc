<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××—×©×‘×•×Ÿ ×©×›×¨ | ××œ×¢×“</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2330;
    --border: #30363d;
    --accent: #58a6ff;
    --accent2: #3fb950;
    --accent3: #f78166;
    --text: #e6edf3;
    --text-muted: #7d8590;
    --gold: #e3b341;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px 16px 80px;
  }

  /* AUTH */
  #auth-screen {
    max-width: 380px;
    margin: 60px auto 0;
  }
  .auth-logo {
    text-align: center;
    margin-bottom: 32px;
  }
  .auth-logo h1 {
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .auth-logo p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }
  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 24px;
  }
  .auth-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 22px;
    background: var(--bg);
    border-radius: 10px;
    padding: 4px;
  }
  .auth-tab {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 7px;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .auth-tab.active {
    background: var(--surface2);
    color: var(--text);
  }
  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
  .field input {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  .field input:focus { outline: none; border-color: var(--accent); }
  .btn-primary {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--accent), #1f6feb);
    border: none;
    border-radius: 10px;
    color: white;
    font-family: 'Heebo', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.2s;
    margin-top: 4px;
  }
  .btn-primary:hover { opacity: 0.85; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .auth-error {
    background: rgba(247,129,102,0.1);
    border: 1px solid rgba(247,129,102,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.85rem;
    color: var(--accent3);
    margin-bottom: 14px;
    display: none;
  }
  .auth-success {
    background: rgba(63,185,80,0.1);
    border: 1px solid rgba(63,185,80,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.85rem;
    color: var(--accent2);
    margin-bottom: 14px;
    display: none;
  }

  /* APP */
  #app-screen { display: none; }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0 24px;
  }
  header h1 {
    font-size: 1.6rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .btn-logout {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Heebo', sans-serif;
    font-size: 0.8rem;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-logout:hover { border-color: var(--accent3); color: var(--accent3); }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    background: var(--surface);
    border-radius: 12px;
    padding: 6px;
    border: 1px solid var(--border);
  }
  .tab {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .tab.active { background: var(--surface2); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.4); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .card-title {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 14px;
  }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .btn-add {
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 1px dashed var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); }

  .day-entry {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
    display: grid;
    grid-template-columns: 100px 1fr 1fr 1fr auto;
    gap: 6px;
    align-items: center;
  }
  .day-entry input {
    padding: 7px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 0.85rem;
    width: 100%;
  }
  .day-entry input:focus { outline: none; border-color: var(--accent); }
  .btn-del { background: none; border: none; color: var(--accent3); cursor: pointer; font-size: 1.1rem; padding: 4px; }

  .breakdown { display: flex; flex-direction: column; gap: 8px; }
  .breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--bg);
    border-radius: 8px;
    font-size: 0.88rem;
  }
  .breakdown-row .val { font-weight: 700; color: var(--gold); direction: ltr; }
  .divider { height: 1px; background: var(--border); margin: 2px 0; }
  .total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: rgba(88,166,255,0.08);
    border: 1px solid rgba(88,166,255,0.2);
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 700;
  }
  .total-row .val { color: var(--accent2); direction: ltr; font-size: 1.05rem; }

  .save-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), #1f6feb);
    border: none;
    border-radius: 10px;
    color: white;
    font-family: 'Heebo', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.2s;
    margin-top: 8px;
  }
  .save-btn:hover { opacity: 0.85; }
  .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .month-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .month-card .month-name { font-weight: 700; font-size: 0.95rem; }
  .month-card .month-hours { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
  .month-card .month-total { font-weight: 900; color: var(--accent2); font-size: 1.05rem; direction: ltr; }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.9rem; }
  .section-hidden { display: none; }
  .day-cols {
    display: grid;
    grid-template-columns: 100px 1fr 1fr 1fr auto;
    gap: 6px;
    margin-bottom: 6px;
    padding: 0 4px;
  }
  .col-header { font-size: 0.7rem; color: var(--text-muted); text-align: center; }

  .loading { text-align: center; padding: 30px; color: var(--text-muted); }
  .spinner {
    display: inline-block;
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-logo">
    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="margin-bottom:12px">
      <defs>
        <linearGradient id="glogo" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#58a6ff"/>
          <stop offset="100%" style="stop-color:#bc8cff"/>
        </linearGradient>
      </defs>
      <rect x="25" y="25" width="50" height="50" rx="10" fill="url(#glogo)" opacity="0.15" transform="rotate(15 50 50)"/>
      <rect x="25" y="25" width="50" height="50" rx="10" fill="none" stroke="url(#glogo)" stroke-width="2.5" transform="rotate(15 50 50)"/>
      <rect x="35" y="55" width="7" height="14" rx="2" fill="url(#glogo)" opacity="0.6"/>
      <rect x="46" y="45" width="7" height="24" rx="2" fill="url(#glogo)" opacity="0.8"/>
      <rect x="57" y="38" width="7" height="31" rx="2" fill="url(#glogo)"/>
      <text x="50" y="32" text-anchor="middle" font-family="Heebo,sans-serif" font-weight="900" font-size="11" fill="url(#glogo)">ES</text>
    </svg>
    <h1>××—×©×‘×•×Ÿ ×©×›×¨</h1>
    <p>×”×ª×—×‘×¨ ×›×“×™ ×œ×©××•×¨ ××ª ×”×”×™×¡×˜×•×¨×™×” ×©×œ×š</p>
  </div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">×”×ª×—×‘×¨×•×ª</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">×”×¨×©××”</button>
    </div>
    <div id="auth-error" class="auth-error"></div>
    <div id="auth-success" class="auth-success"></div>
    <div class="field">
      <label>××™××™×™×œ</label>
      <input type="email" id="auth-email" placeholder="your@email.com" dir="ltr">
    </div>
    <div class="field">
      <label>×¡×™×¡××”</label>
      <input type="password" id="auth-password" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×" dir="ltr">
    </div>
    <button class="btn-primary" id="auth-btn" onclick="doAuth()">×”×ª×—×‘×¨</button>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen">
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <svg width="36" height="36" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="glogo2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#58a6ff"/>
            <stop offset="100%" style="stop-color:#bc8cff"/>
          </linearGradient>
        </defs>
        <rect x="25" y="25" width="50" height="50" rx="10" fill="url(#glogo2)" opacity="0.15" transform="rotate(15 50 50)"/>
        <rect x="25" y="25" width="50" height="50" rx="10" fill="none" stroke="url(#glogo2)" stroke-width="2.5" transform="rotate(15 50 50)"/>
        <rect x="35" y="55" width="7" height="14" rx="2" fill="url(#glogo2)" opacity="0.6"/>
        <rect x="46" y="45" width="7" height="24" rx="2" fill="url(#glogo2)" opacity="0.8"/>
        <rect x="57" y="38" width="7" height="31" rx="2" fill="url(#glogo2)"/>
        <text x="50" y="32" text-anchor="middle" font-family="Heebo,sans-serif" font-weight="900" font-size="11" fill="url(#glogo2)">ES</text>
      </svg>
      <h1>××—×©×‘×•×Ÿ ×©×›×¨</h1>
    </div>
    <button class="btn-logout" onclick="doLogout()">×”×ª× ×ª×§</button>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="showTab('calc')">ğŸ§® ×—×™×©×•×‘</button>
    <button class="tab" onclick="showTab('weekly')">ğŸ“… ×©×‘×•×¢×™</button>
    <button class="tab" onclick="showTab('history')">ğŸ“Š ×”×™×¡×˜×•×¨×™×”</button>
  </div>

  <!-- CALC TAB -->
  <div id="tab-calc">
    <div class="card">
      <div class="card-title">âš™ï¸ × ×ª×•× ×™ ×‘×¡×™×¡</div>
      <div class="row">
        <div class="field">
          <label>×¢×¨×š ×©×¢×” (â‚ª)</label>
          <input type="number" id="rate" value="38.44" step="0.01" oninput="recalc()">
        </div>
        <div class="field">
          <label>×©× ×”×—×•×“×©</label>
          <input type="text" id="monthName" placeholder="×¤×‘×¨×•××¨ 2026">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">â° ×©×¢×•×ª ×¢×‘×•×“×”</div>
      <div class="day-cols">
        <span class="col-header">×ª××¨×™×š</span>
        <span class="col-header">×¨×’×™×œ×•×ª</span>
        <span class="col-header">125%</span>
        <span class="col-header">150%</span>
        <span></span>
      </div>
      <div id="days-list"></div>
      <button class="btn-add" onclick="addDay()">+ ×”×•×¡×£ ×™×•×</button>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“‹ ×‘×¨×•×˜×• ×¦×¤×•×™</div>
      <div class="breakdown">
        <div class="breakdown-row"><span>×©×¢×•×ª ×¨×’×™×œ×•×ª</span><span class="val" id="r-regular">0.00 â‚ª</span></div>
        <div class="breakdown-row"><span>×©×¢×•×ª × ×•×¡×¤×•×ª 125%</span><span class="val" id="r-125">0.00 â‚ª</span></div>
        <div class="breakdown-row"><span>×©×¢×•×ª × ×•×¡×¤×•×ª 150%</span><span class="val" id="r-150">0.00 â‚ª</span></div>
        <div class="divider"></div>
        <div class="breakdown-row"><span>×ª×•×¡×¤×•×ª ×§×‘×•×¢×•×ª (×•×ª×§, ×—×•×§)</span><span class="val">557.56 â‚ª</span></div>
        <div class="breakdown-row"><span>×”×—×–×¨×™ ×”×•×¦××•×ª (× ×¡×™×¢×”, ×‘×™×’×•×“, ×›×œ×›×œ×”)</span><span class="val">406.95 â‚ª</span></div>
        <div class="breakdown-row"><span>×”×‘×¨××” ×—×•×“×©×™×ª</span><span class="val">166.01 â‚ª</span></div>
        <div class="breakdown-row"><span style="color:var(--accent3)">×”×¤×—×ª×” (1.2%)</span><span class="val" id="r-haf" style="color:var(--accent3)">0.00 â‚ª</span></div>
        <div class="divider"></div>
        <div id="minwage-row" style="display:none" class="breakdown-row">
          <span style="color:var(--gold)">âš ï¸ ×”×©×œ××” ×œ×©×›×¨ ××™× ×™××•×</span>
          <span class="val" id="r-minwage" style="color:var(--gold)">0.00 â‚ª</span>
        </div>
        <div class="total-row"><span>×¡×”"×› ×‘×¨×•×˜×• ×¦×¤×•×™</span><span class="val" id="r-total">0.00 â‚ª</span></div>
      </div>
      <button class="save-btn" id="save-btn" onclick="saveMonth()">ğŸ’¾ ×©××•×¨ ×—×•×“×©</button>
    </div>
  </div>

  <!-- WEEKLY TAB -->
  <div id="tab-weekly" class="section-hidden">
    <div class="card">
      <div class="card-title">ğŸ“… ×”×›× ×¡×” ×©×‘×•×¢×™×ª</div>
      <div class="field">
        <label>×©× ×”×—×•×“×©</label>
        <input type="text" id="weekMonthName" placeholder="×¤×‘×¨×•××¨ 2026">
      </div>
      <div id="weeks-container"></div>
      <button class="btn-add" onclick="addWeek()">+ ×”×•×¡×£ ×©×‘×•×¢</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ ×¡×™×›×•×</div>
      <div class="breakdown">
        <div class="breakdown-row"><span>×¡×”"×› ×©×¢×•×ª ×¨×’×™×œ×•×ª</span><span class="val" id="wr-regular">0</span></div>
        <div class="breakdown-row"><span>×©×¢×•×ª × ×•×¡×¤×•×ª 125%</span><span class="val" id="wr-125">0</span></div>
        <div class="breakdown-row"><span>×©×¢×•×ª × ×•×¡×¤×•×ª 150%</span><span class="val" id="wr-150">0</span></div>
        <div class="divider"></div>
        <div class="total-row"><span>×‘×¨×•×˜×• ×¦×¤×•×™</span><span class="val" id="wr-total">0.00 â‚ª</span></div>
      </div>
      <button class="save-btn" onclick="saveWeeklyMonth()">ğŸ’¾ ×©××•×¨ ×—×•×“×©</button>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="tab-history" class="section-hidden">
    <div class="card">
      <div class="card-title">ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ×—×•×“×©×™×</div>
      <div id="history-list"><div class="loading"><div class="spinner"></div><br>×˜×•×¢×Ÿ...</div></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://weqaagygrebsmyfilrrs.supabase.co';
const SUPABASE_KEY = 'sb_publishable_s9Dl7sEYll2N3VnPqnuyGQ_wmSNxmyH';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const FIXED_ADDITIONS = 557.56;
const FIXED_EXPENSES = 406.95;
const FIXED_HAVRAAH = 166.01;
const HAFCHATA_RATE = 0.012;
const MIN_WAGE = 6247.67;

let currentUser = null;
let dayCount = 0;
let weekCount = 0;
let authMode = 'login';

// ---- AUTH ----
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    showApp();
  }
  sb.auth.onAuthStateChange((event, session) => {
    if (session) { currentUser = session.user; showApp(); }
    else { currentUser = null; showAuth(); }
  });
}

function switchAuthTab(mode) {
  authMode = mode;
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.className = 'auth-tab' + (['login','register'][i] === mode ? ' active' : '');
  });
  document.getElementById('auth-btn').textContent = mode === 'login' ? '×”×ª×—×‘×¨' : '×”×™×¨×©×';
  clearAuthMessages();
}

function clearAuthMessages() {
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  el.textContent = msg;
  el.style.display = 'block';
}

async function doAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const btn = document.getElementById('auth-btn');
  clearAuthMessages();

  if (!email || !password) return showAuthError('×™×© ×œ××œ× ××™××™×™×œ ×•×¡×™×¡××”');
  if (password.length < 6) return showAuthError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×');

  btn.disabled = true;
  btn.textContent = '...';

  if (authMode === 'register') {
    const { error } = await sb.auth.signUp({ email, password });
    btn.disabled = false;
    btn.textContent = '×”×™×¨×©×';
    if (error) return showAuthError(error.message);
    showAuthSuccess('âœ… × ×¨×©××ª ×‘×”×¦×œ×—×”! ×‘×“×•×§ ××ª ×”××™×™×œ ×œ××™×©×•×¨, ×•××– ×”×ª×—×‘×¨.');
  } else {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    btn.disabled = false;
    btn.textContent = '×”×ª×—×‘×¨';
    if (error) return showAuthError('××™××™×™×œ ××• ×¡×™×¡××” ×©×’×•×™×™×');
  }
}

async function doLogout() {
  await sb.auth.signOut();
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';
  if (document.getElementById('days-list').children.length === 0) addDay();
}

function showAuth() {
  document.getElementById('auth-screen').style.display = 'block';
  document.getElementById('app-screen').style.display = 'none';
}

// ---- TABS ----
function showTab(tab) {
  ['calc','weekly','history'].forEach(t => {
    document.getElementById('tab-'+t).className = t === tab ? '' : 'section-hidden';
  });
  document.querySelectorAll('.tab').forEach((btn, i) => {
    btn.className = 'tab' + (['calc','weekly','history'][i] === tab ? ' active' : '');
  });
  if (tab === 'history') loadHistory();
}

// ---- CALC ----
function calcBruto(reg, h125, h150) {
  const rate = parseFloat(document.getElementById('rate').value || 38.44);
  const regAmt = reg * rate;
  const h125Amt = h125 * (rate * 1.25);
  const h150Amt = h150 * (rate * 1.50);
  const base = regAmt + h125Amt + h150Amt;
  const haf = -(base * HAFCHATA_RATE);
  const subtotal = base + haf + FIXED_ADDITIONS + FIXED_EXPENSES + FIXED_HAVRAAH;
  const minwage = Math.max(0, MIN_WAGE - subtotal);
  const total = subtotal + minwage;
  return {regAmt, h125Amt, h150Amt, haf, minwage, total};
}

function addDay(date='', reg='', h125='', h150='') {
  dayCount++;
  const id = dayCount;
  const div = document.createElement('div');
  div.className = 'day-entry';
  div.id = 'day-'+id;
  div.innerHTML = `
    <input type="date" value="${date}" id="date-${id}" style="padding:7px 6px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:Heebo,sans-serif;font-size:0.78rem;">
    <input type="number" placeholder="×©×¢×•×ª" value="${reg}" step="0.25" id="reg-${id}" oninput="recalc()">
    <input type="number" placeholder="125%" value="${h125}" step="0.25" id="h125-${id}" oninput="recalc()">
    <input type="number" placeholder="150%" value="${h150}" step="0.25" id="h150-${id}" oninput="recalc()">
    <button class="btn-del" onclick="removeDay(${id})">âœ•</button>`;
  document.getElementById('days-list').appendChild(div);
  recalc();
}

function removeDay(id) {
  document.getElementById('day-'+id).remove();
  recalc();
}

function collectDays() {
  let reg = 0, h125 = 0, h150 = 0;
  for (let i = 1; i <= dayCount; i++) {
    if (!document.getElementById('day-'+i)) continue;
    reg += parseFloat(document.getElementById('reg-'+i).value || 0);
    h125 += parseFloat(document.getElementById('h125-'+i).value || 0);
    h150 += parseFloat(document.getElementById('h150-'+i).value || 0);
  }
  return {reg, h125, h150};
}

function recalc() {
  const {reg, h125, h150} = collectDays();
  const c = calcBruto(reg, h125, h150);
  document.getElementById('r-regular').textContent = c.regAmt.toFixed(2) + ' â‚ª';
  document.getElementById('r-125').textContent = c.h125Amt.toFixed(2) + ' â‚ª';
  document.getElementById('r-150').textContent = c.h150Amt.toFixed(2) + ' â‚ª';
  document.getElementById('r-haf').textContent = c.haf.toFixed(2) + ' â‚ª';
  document.getElementById('r-total').textContent = c.total.toFixed(2) + ' â‚ª';
  const mw = document.getElementById('minwage-row');
  if (c.minwage > 0) {
    mw.style.display = 'flex';
    document.getElementById('r-minwage').textContent = '+' + c.minwage.toFixed(2) + ' â‚ª';
  } else {
    mw.style.display = 'none';
  }
}

async function saveMonth() {
  const name = document.getElementById('monthName').value || '×—×•×“×© ×œ× ×™×“×•×¢';
  const {reg, h125, h150} = collectDays();
  const c = calcBruto(reg, h125, h150);
  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.textContent = '×©×•××¨...';

  const { error } = await sb.from('salary_months').insert({
    user_id: currentUser.id,
    month_name: name,
    reg_hours: reg,
    hours_125: h125,
    hours_150: h150,
    total_bruto: c.total
  });

  btn.disabled = false;
  btn.textContent = 'ğŸ’¾ ×©××•×¨ ×—×•×“×©';

  if (error) { alert('×©×’×™××” ×‘×©××™×¨×”: ' + error.message); return; }
  alert('âœ… ×”×—×•×“×© × ×©××¨ ×‘×¢× ×Ÿ!');
}

// ---- WEEKLY ----
function addWeek() {
  weekCount++;
  const wid = weekCount;
  const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  const div = document.createElement('div');
  div.id = 'week-'+wid;
  div.style.marginBottom = '16px';
  let rows = days.map((d, i) => `
    <div style="display:grid;grid-template-columns:55px 1fr 1fr 1fr;gap:6px;margin-bottom:5px;align-items:center">
      <span style="font-size:0.78rem;color:var(--text-muted)">${d}</span>
      <input type="number" placeholder="×¨×’×™×œ" step="0.25" id="w${wid}d${i}reg" oninput="weekRecalc()" style="padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:Heebo,sans-serif;font-size:0.82rem;">
      <input type="number" placeholder="125%" step="0.25" id="w${wid}d${i}h125" oninput="weekRecalc()" style="padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:Heebo,sans-serif;font-size:0.82rem;">
      <input type="number" placeholder="150%" step="0.25" id="w${wid}d${i}h150" oninput="weekRecalc()" style="padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:Heebo,sans-serif;font-size:0.82rem;">
    </div>`).join('');
  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-weight:700;font-size:0.85rem">×©×‘×•×¢ ${wid}</span>
      <button class="btn-del" onclick="removeWeek(${wid})">âœ• ×”×¡×¨</button>
    </div>
    <div style="display:grid;grid-template-columns:55px 1fr 1fr 1fr;gap:6px;margin-bottom:4px">
      <span></span>
      <span style="font-size:0.7rem;color:var(--text-muted);text-align:center">×¨×’×™×œ</span>
      <span style="font-size:0.7rem;color:var(--text-muted);text-align:center">125%</span>
      <span style="font-size:0.7rem;color:var(--text-muted);text-align:center">150%</span>
    </div>
    ${rows}
    <div style="height:1px;background:var(--border);margin-top:8px"></div>`;
  document.getElementById('weeks-container').appendChild(div);
}

function removeWeek(wid) {
  document.getElementById('week-'+wid).remove();
  weekRecalc();
}

function weekRecalc() {
  let reg = 0, h125 = 0, h150 = 0;
  for (let w = 1; w <= weekCount; w++) {
    if (!document.getElementById('week-'+w)) continue;
    for (let d = 0; d < 7; d++) {
      reg += parseFloat(document.getElementById(`w${w}d${d}reg`)?.value || 0);
      h125 += parseFloat(document.getElementById(`w${w}d${d}h125`)?.value || 0);
      h150 += parseFloat(document.getElementById(`w${w}d${d}h150`)?.value || 0);
    }
  }
  const c = calcBruto(reg, h125, h150);
  document.getElementById('wr-regular').textContent = reg.toFixed(2) + ' ×©×³';
  document.getElementById('wr-125').textContent = h125.toFixed(2) + ' ×©×³';
  document.getElementById('wr-150').textContent = h150.toFixed(2) + ' ×©×³';
  document.getElementById('wr-total').textContent = c.total.toFixed(2) + ' â‚ª';
  window._weekData = {reg, h125, h150, total: c.total};
}

async function saveWeeklyMonth() {
  const name = document.getElementById('weekMonthName').value || '×—×•×“×© ×œ× ×™×“×•×¢';
  const d = window._weekData || {reg:0, h125:0, h150:0, total:0};
  const { error } = await sb.from('salary_months').insert({
    user_id: currentUser.id,
    month_name: name,
    reg_hours: d.reg,
    hours_125: d.h125,
    hours_150: d.h150,
    total_bruto: d.total
  });
  if (error) { alert('×©×’×™××”: ' + error.message); return; }
  alert('âœ… ×”×—×•×“×© × ×©××¨ ×‘×¢× ×Ÿ!');
}

// ---- HISTORY ----
async function loadHistory() {
  const list = document.getElementById('history-list');
  list.innerHTML = '<div class="loading"><div class="spinner"></div><br>×˜×•×¢×Ÿ...</div>';

  const { data, error } = await sb.from('salary_months')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (error) { list.innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×”</div>'; return; }
  if (!data || data.length === 0) {
    list.innerHTML = '<div class="empty-state">×¢×“×™×™×Ÿ ××™×Ÿ ×—×•×“×©×™× ×©××•×¨×™×.<br>×—×©×‘ ×•×©××•×¨ ×—×•×“×© ×›×“×™ ×œ×”×ª×—×™×œ!</div>';
    return;
  }

  const avg = data.reduce((s, m) => s + m.total_bruto, 0) / data.length;

  list.innerHTML = data.map(m => `
    <div class="month-card">
      <div>
        <div class="month-name">${m.month_name}</div>
        <div class="month-hours">${(m.reg_hours||0).toFixed(1)} ×©×³ ×¨×’×™×œ | ${(m.hours_125||0).toFixed(1)} ×©×³ 125% | ${(m.hours_150||0).toFixed(1)} ×©×³ 150%</div>
      </div>
      <div style="text-align:left">
        <div class="month-total">${m.total_bruto.toFixed(2)} â‚ª</div>
        <button onclick="deleteMonth('${m.id}')" style="background:none;border:none;color:var(--accent3);font-size:0.75rem;cursor:pointer;font-family:Heebo,sans-serif">××—×§</button>
      </div>
    </div>`).join('') +
    (data.length > 1 ? `
      <div style="margin-top:16px;padding:14px;background:rgba(63,185,80,0.08);border:1px solid rgba(63,185,80,0.2);border-radius:10px;text-align:center">
        <div style="font-size:0.8rem;color:var(--text-muted)">×××•×¦×¢ ×‘×¨×•×˜×• (${data.length} ×—×•×“×©×™×)</div>
        <div style="font-size:1.6rem;font-weight:900;color:var(--accent2)">${avg.toFixed(2)} â‚ª</div>
      </div>` : '');
}

async function deleteMonth(id) {
  if (!confirm('×œ××—×•×§ ×—×•×“×© ×–×”?')) return;
  await sb.from('salary_months').delete().eq('id', id);
  loadHistory();
}

init();
</script>
</body>
</html>
